# Agent guide

Instructions for AI agents working in this repository.

## Repository overview

This repo contains a tool that computes week-over-week PR throughput metrics for GitHub repositories. The primary implementation is in Go (`cmd/throughput/`), with a legacy bash script (`throughput.sh`).

## Build and run

```sh
go build ./cmd/throughput/
./throughput --repo gitpod-io/gitpod-next --weeks 12
```

Or without a build step:

```sh
go run ./cmd/throughput/ --repo gitpod-io/gitpod-next --weeks 12
```

## Code layout

All Go source lives in `cmd/throughput/`:

- `main.go` — Entry point, CLI flag parsing, week range computation, orchestration.
- `token.go` — Resolves GitHub token from env vars or git credential helper.
- `graphql.go` — GraphQL HTTP client with retry (3 attempts, backoff) and rate-limit handling.
- `fetch.go` — Concurrent PR fetching. Uses a bounded goroutine pool (10 workers). Each worker fetches one week's PRs with pagination.
- `metrics.go` — Filters out bots and excluded users. Computes cycle time (first commit to merge), review turnaround (PR created to first review), Ona co-authorship. Percentile calculation (median, p90) uses linear interpolation matching the bash awk implementation.
- `csv.go` — Buckets enriched PRs into week ranges and formats CSV output.

## Key design decisions

- **Concurrency model**: Weeks are fetched in parallel, pagination within a week is serial. This saturates the API without hitting rate limits.
- **Percentile calculation**: Uses 1-based linear interpolation to match the awk implementation in `throughput.sh`. Do not change this without verifying output parity.
- **Ona co-authorship regex**: `(?i)Co-authored-by:.*[Oo]na.*@ona\.com` — matches the bash `jq` pattern. Case-insensitive.
- **Bot detection**: Uses the GraphQL `__typename` field. PRs from authors with `__typename == "Bot"` are excluded.
- **Default exclusions**: Hardcoded in `main.go` as `defaultExclude`. Additional exclusions come from the `--exclude` flag.

## Testing changes

After modifying the Go code:

1. Verify it compiles: `go build ./cmd/throughput/`
2. Run a short test: `./throughput --repo gitpod-io/gitpod-next --weeks 2`
3. Compare output against the reference CSV (`throughput-gitpod-next.csv`) — the last N weeks should match if run on the same date the reference was generated.

## Reference data

`throughput-gitpod-next.csv` contains a 52-week run against `gitpod-io/gitpod-next` generated by the bash script. Use it to validate output parity when making changes to metric computation or CSV formatting.

## Environment

The devcontainer includes Go 1.23 (configured in `.devcontainer/devcontainer.json`). No external dependencies beyond the Go standard library.
